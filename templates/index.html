<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Photo Tagger</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />
  
  <script>
    // Configuration Constants - Easy to modify
    const CONFIG = {
      GRID: {
        COLS_SMALL: 2,      // Columns on small screens
        COLS_MEDIUM: 4,     // Columns on medium screens  
        COLS_LARGE: 6       // Columns on large screens
      },
      PAGINATION: {
        ITEMS_PER_PAGE: 24  // Adjust based on your backend pagination
      },
      UI: {
        CARD_SPACING: 3,    // Bootstrap spacing class number (g-3)
        BUTTON_SIZES: {
          TAG: 'btn-sm',
          REMOVE: 'btn-sm'
        }
      },
      URLS: {
        DRIVE_VIEW_BASE: 'https://drive.google.com/file/d/',
        DRIVE_VIEW_SUFFIX: '/view'
      },
      MESSAGES: {
        DELETE_ALL_CONFIRM: 'Are you sure you want to delete ALL photos and their tags? This cannot be undone.',
        NO_PHOTOS: 'No photos found.',
        NO_BACKUPS: 'No backups found'
      },
      PLACEHOLDERS: {
        SEARCH: 'Search tags or photo IDs (comma separated)',
        UPLOAD_LINK: 'Google Drive file or folder links (comma separated)',
        UPLOAD_TAGS: 'Tags (comma separated)',
        NEW_TAG: 'New Tag',
        RENAME_TAG: 'New name'
      }
    };
  </script>
</head>
<body class="p-4">
  <h1 class="mb-4 text-center">Photo Tagger</h1>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-container mb-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category if category != 'message' else 'info' }} flash-message">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Search -->
  <section class="mb-4">
    <h3>Search</h3>
    <form method="get" action="/" class="search-form mb-2">
      <input
        name="q"
        class="form-control"
        placeholder="Search tags or photo IDs (comma separated)"
        value="{{ request.args.get('q', '') }}"
      />
    </form>

    {% if all_tags %}
      <div class="available-tags">
        <strong>Available tags to search:</strong>
        {% for tag in all_tags %}
          <a href="/?q={{ tag }}" class="btn btn-sm btn-outline-secondary m-1">{{ tag }}</a>
        {% endfor %}
      </div>
    {% endif %}
    
    <!-- Clear search button when searching -->
    {% if request.args.get('q') %}
      <div class="mt-2">
        <a href="/" class="btn btn-sm btn-outline-primary">Clear Search</a>
        <span class="text-muted ms-2">Searching for: <strong>{{ request.args.get('q') }}</strong></span>
      </div>
    {% endif %}
  </section>

  <!-- Rename Tag -->
  <section class="mb-5">
    <h3>Rename Tag</h3>
    <form method="post" action="/tag/edit" class="row g-2 align-items-center rename-form">
      <div class="col-auto flex-grow-1">
        <select name="old_tag" id="old_tag" class="form-select" required>
          <option value="" disabled selected>Choose tag…</option>
          {% for tag in all_tags %}
            <option value="{{ tag }}">{{ tag }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto flex-grow-1">
        <input
          name="new_tag"
          id="new_tag"
          type="text"
          class="form-control"
          placeholder="New name"
          required
        />
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-secondary">Rename</button>
      </div>
    </form>
  </section>

  <!-- Upload Photos + Tags -->
  <section class="mb-5">
    <h3>Upload Photos + Tags</h3>
    <form method="post" class="upload-form">
      <input
        name="link"
        class="form-control mb-2"
        placeholder="Google Drive file or folder links (comma separated)"
        required
      />
      <input name="tag" class="form-control mb-3" placeholder="Tags (comma separated)" />
      <button class="btn btn-primary">Add Photos</button>
    </form>
  </section>

  <!-- Backups List -->
  <section class="mb-5">
    <h4>Backups</h4>
    <ul class="list-group backups-list">
      {% for b in backups %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          Backup {{ b[0] }} - {{ b[1] }}
          <div class="btn-group" role="group">
            <form method="post" action="/backup/load/{{ b[0] }}" class="m-0 p-0">
              <button type="submit" class="btn btn-sm btn-primary" title="Load backup and attempt to refresh thumbnails">Load</button>
            </form>
            <form method="post" action="/backup/refresh/{{ b[0] }}" class="m-0 p-0 ms-1">
              <button type="submit" class="btn btn-sm btn-info" title="Force refresh thumbnails for this backup">Refresh Thumbs</button>
            </form>
            <form method="post" action="/backup/delete/{{ b[0] }}" class="m-0 p-0 ms-1">
              <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this backup permanently?')">Delete</button>
            </form>
          </div>
        </li>
      {% else %}
        <li class="list-group-item">No backups found</li>
      {% endfor %}
    </ul>

    <!-- Backup Name Input -->
    <form method="post" action="/backup/save" class="mb-3">
      <div class="d-flex align-items-center flex-nowrap" style="max-width: 700px;">
        <input 
          name="backup_name" 
          class="form-control me-2 flex-shrink-1" 
          placeholder="Backup name (optional)" 
        />
        <button type="submit" class="btn btn-warning flex-shrink-0">Save Backup</button>
      </div>
    </form>

    <!-- Delete All Photos Button -->
    <form method="post" action="/delete/all" onsubmit="return confirm('Are you sure you want to delete ALL photos and their tags? This cannot be undone.');">
      <button type="submit" class="btn btn-danger mb-3">Delete All Photos</button>
    </form>
  </section>

  <!-- Photo Previews Grid -->
  <section>
    <div class="row row-cols-2 row-cols-md-4 row-cols-xl-6 g-3">
      {% for item in data %}
        <div class="col">
          <div class="card h-100 photo-card">
            <img
              src="{{ item.thumb_url }}"
              alt="Photo thumbnail for {{ item.id }}"
              class="card-img-top"
              loading="lazy"
            />
            <form method="post" action="/removephoto" class="mb-2 remove-photo-form">
              <input type="hidden" name="id" value="{{ item.id }}" />
              <!-- Preserve search and page parameters -->
              {% if request.args.get('q') %}
                <input type="hidden" name="return_url" value="/?q={{ request.args.get('q') | urlencode }}&page={{ page }}">
              {% else %}
                <input type="hidden" name="return_url" value="/?page={{ page }}">
              {% endif %}
              <button class="btn btn-sm btn-outline-danger w-100">Remove Photo</button>
            </form>
            <div class="card-body p-3 d-flex flex-column">
              <p class="mb-1 text-truncate"><strong>ID:</strong> {{ item.id }}</p>
              <p class="mb-2">
                <a href="https://drive.google.com/file/d/{{ item.id }}/view" target="_blank" rel="noopener noreferrer">View on Drive</a>
              </p>
              <p class="mb-1"><strong>Tags:</strong></p>
              <div class="tags-list mb-2">
                {% for tag in item.tags %}
                  <form method="post" action="/removetag" class="d-inline-block me-1 mb-1">
                    <input type="hidden" name="id" value="{{ item.id }}" />
                    <input type="hidden" name="tag" value="{{ tag }}" />
                    <!-- Preserve search and page parameters -->
                    {% if request.args.get('q') %}
                      <input type="hidden" name="return_url" value="/?q={{ request.args.get('q') | urlencode }}&page={{ page }}">
                    {% else %}
                      <input type="hidden" name="return_url" value="/?page={{ page }}">
                    {% endif %}
                    <button class="btn btn-sm btn-outline-danger tag-btn">{{ tag }} ✕</button>
                  </form>
                {% endfor %}
              </div>
              <form method="post" class="d-flex mt-auto add-tag-form">
                <input type="hidden" name="photo_id" value="{{ item.id }}" />
                <input
                  name="tag"
                  class="form-control form-control-sm me-2"
                  placeholder="New Tag"
                  required
                />
                <button class="btn btn-sm btn-primary" type="submit">Add</button>
              </form>
            </div>
          </div>
        </div>
      {% else %}
        <p>No photos found.</p>
      {% endfor %}
    </div>
  </section>

  <!-- Pagination -->
  {% if total_pages > 1 %}
    <nav aria-label="Page navigation" class="mt-5">
      <ul class="pagination justify-content-center">
        {% set search_param = '&q=' + request.args.get('q', '') if request.args.get('q') else '' %}
        
        <!-- Previous page -->
        {% if page > 1 %}
          <li class="page-item">
            <a class="page-link" href="/?page={{ page - 1 }}{{ search_param }}">Previous</a>
          </li>
        {% endif %}
        
        <!-- Page numbers -->
        {% for p in range(1, total_pages + 1) %}
          {% if p == page %}
            <li class="page-item active">
              <span class="page-link">{{ p }}</span>
            </li>
          {% else %}
            <li class="page-item">
              <a class="page-link" href="/?page={{ p }}{{ search_param }}">{{ p }}</a>
            </li>
          {% endif %}
        {% endfor %}
        
        <!-- Next page -->
        {% if page < total_pages %}
          <li class="page-item">
            <a class="page-link" href="/?page={{ page + 1 }}{{ search_param }}">Next</a>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}

  <!-- Results summary -->
  {% if request.args.get('q') %}
    <div class="text-center mt-3">
      <small class="text-muted">
        Showing page {{ page }} of {{ total_pages }} 
        {% if total_pages > 1 %}({{ ((page-1) * 40 + 1) }}-{{ (page * 40) if page < total_pages else 'end' }} of filtered results){% endif %}
      </small>
    </div>
  {% endif %}

<!-- Debugging Tools -->
<div class="debug-controls mt-5 p-3 bg-light rounded">
    <h4>Debug Tools</h4>
    
    <!-- Full diagnostics -->
    <a href="/diagnostics" class="btn btn-info me-2">Run Diagnostics</a>
    
    <!-- Test mode refresh (only 5 files) -->
    <form method="POST" action="/refresh/thumbnails" style="display: inline;" class="me-2">
        <input type="hidden" name="test_mode" value="true">
        <button type="submit" class="btn btn-primary">Test Refresh (5 files)</button>
    </form>
    
    <!-- Test single file -->
    <form method="POST" action="/test/single/1K3Na36ffxR4L1Fv6fXESfGzn8iih2kgh" style="display: inline;" class="me-2">
        <button type="submit" class="btn btn-secondary">Test Single File</button>
    </form>

    <!-- Thumbnail Refresh -->
    <form method="POST" action="/refresh/thumbnails" style="display: inline;" class="me-2">
        <button type="submit" class="btn btn-warning" onclick="return confirm('This will refresh ALL thumbnails. Continue?')">
            Refresh All Thumbnails
        </button>
    </form>

    <!-- Clear without regenerating -->
    <form method="POST" action="/clear/thumbnails" style="display: inline;">
        <button type="submit" class="btn btn-secondary" onclick="return confirm('This will clear all thumbnails. Continue?')">
            Clear All Thumbnails
        </button>
    </form>
</div>

</body>
</html>